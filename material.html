function renderTable() {
  const selectedDate = datePicker.value;
  if (!selectedDate) return;

  let filteredData = [];
  if (currentFilter === 'month') {
    filteredData = allData.filter(item => item.date.startsWith(selectedDate));
  } else {
    filteredData = allData.filter(item => item.date === selectedDate);
  }

  recordsTableBody.innerHTML = "";

  if (filteredData.length === 0) {
    recordsTableBody.innerHTML = `<tr><td colspan="6">目前無此期間的記錄</td></tr>`; // 改為6欄
    return;
  }

  filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));

  filteredData.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.date}</td>
      <td>${item.type === "income" ? "收入" : "支出"}</td>
      <td>${item.amount.toFixed(2)}</td>
      <td>${item.note || ""}</td>
      <td>
        <button class="edit-btn" data-id="${item.id}">編輯</button>
        <button class="delete-btn" data-id="${item.id}">刪除</button>
      </td>
    `;
    recordsTableBody.appendChild(tr);
  });

  // 刪除功能
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      if (confirm("確定要刪除這筆記錄嗎？")) {
        try {
          await db.collection("records").doc(id).delete();
          alert("✅ 已刪除");
          await loadData();
          renderDateOptions();
          renderTable();
        } catch (err) {
          alert("❌ 刪除失敗：" + err.message);
          console.error(err);
        }
      }
    });
  });

  // 編輯功能
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      const record = allData.find(item => item.id === id);
      if (!record) return;

      const newDate = prompt("輸入新日期 (YYYY-MM-DD)：", record.date);
      const newType = prompt("輸入類型 (income 或 expense)：", record.type);
      const newAmount = parseFloat(prompt("輸入金額：", record.amount));
      const newNote = prompt("輸入備註：", record.note || "");

      if (!newDate || isNaN(newAmount) || (newType !== 'income' && newType !== 'expense')) {
        alert("❌ 輸入有誤，請重新檢查！");
        return;
      }

      try {
        await db.collection("records").doc(id).update({
          date: newDate,
          type: newType,
          amount: newAmount,
          note: newNote
        });
        alert("✅ 已更新");
        await loadData();
        renderDateOptions();
        renderTable();
      } catch (err) {
        alert("❌ 更新失敗：" + err.message);
        console.error(err);
      }
    });
  });
}
