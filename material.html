<script>
  // Firebase 設定
  const firebaseConfig = {
    apiKey: "AIzaSyDEOsfYrAGpAnYsiYyBpaYCC-EFL9dnL6k",
    authDomain: "project-1743045136631756226.firebaseapp.com",
    projectId: "project-1743045136631756226",
    storageBucket: "project-1743045136631756226.appspot.com",
    messagingSenderId: "660576126542",
    appId: "1:660576126542:web:ff0f574ec65385b7fa251f",
    measurementId: "G-31VC1RK1HK"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const btnMonth = document.getElementById("btnMonth");
  const btnDay = document.getElementById("btnDay");
  const datePicker = document.getElementById("datePicker");
  const recordsTableBody = document.getElementById("recordsTableBody");

  // 新增收入/支出過濾按鈕元素
  const btnIncome = document.getElementById("btnIncome");
  const btnExpense = document.getElementById("btnExpense");

  let allData = [];
  let currentFilter = 'month'; // 'month' 或 'day'
  let currentTypeFilter = 'income'; // 'income' 或 'expense'

  async function loadData() {
    const snapshot = await db.collection("records").get();
    allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  function renderDateOptions() {
    datePicker.innerHTML = "";
    let filteredByType = allData.filter(item => {
      if (currentTypeFilter === 'income') return item.type === 'income';
      else return item.type === 'expense';
    });

    if (currentFilter === 'month') {
      // 取出所有不同月份 (YYYY-MM)
      const months = [...new Set(filteredByType.map(item => item.date.slice(0, 7)))].sort().reverse();
      months.forEach(month => {
        const option = document.createElement("option");
        option.value = month;
        option.textContent = month;
        datePicker.appendChild(option);
      });
    } else {
      // 按日 - 取出所有不同日期 (YYYY-MM-DD)
      const days = [...new Set(filteredByType.map(item => item.date))].sort().reverse();
      days.forEach(day => {
        const option = document.createElement("option");
        option.value = day;
        option.textContent = day;
        datePicker.appendChild(option);
      });
    }
  }

  function renderTable() {
    const selectedDate = datePicker.value;
    if (!selectedDate) {
      recordsTableBody.innerHTML = `<tr><td colspan="5">目前無此期間的記錄</td></tr>`;
      return;
    }

    let filteredData = allData.filter(item => {
      // 先過濾類型
      if (currentTypeFilter === 'income' && item.type !== 'income') return false;
      if (currentTypeFilter === 'expense' && item.type !== 'expense') return false;

      // 再過濾日期
      if (currentFilter === 'month') {
        return item.date.startsWith(selectedDate);
      } else {
        return item.date === selectedDate;
      }
    });

    recordsTableBody.innerHTML = "";

    if (filteredData.length === 0) {
      recordsTableBody.innerHTML = `<tr><td colspan="5">目前無此期間的記錄</td></tr>`;
      return;
    }

    filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredData.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.date}</td>
        <td>${item.type === "income" ? "收入" : "支出"}</td>
        <td>${item.amount.toFixed(2)}</td>
        <td>${item.note || ""}</td>
        <td><button class="delete-btn" data-id="${item.id}">刪除</button></td>
      `;
      recordsTableBody.appendChild(tr);
    });

    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async e => {
        const id = e.target.dataset.id;
        if (confirm("確定要刪除這筆記錄嗎？")) {
          try {
            await db.collection("records").doc(id).delete();
            alert("✅ 已刪除");
            await loadData();
            renderDateOptions();
            renderTable();
          } catch (err) {
            alert("❌ 刪除失敗：" + err.message);
            console.error(err);
          }
        }
      });
    });
  }

  btnMonth.addEventListener("click", () => {
    if (currentFilter !== 'month') {
      currentFilter = 'month';
      btnMonth.classList.add("active");
      btnDay.classList.remove("active");
      document.querySelector("label[for='datePicker']").textContent = "選擇月份：";
      renderDateOptions();
      renderTable();
    }
  });

  btnDay.addEventListener("click", () => {
    if (currentFilter !== 'day') {
      currentFilter = 'day';
      btnDay.classList.add("active");
      btnMonth.classList.remove("active");
      document.querySelector("label[for='datePicker']").textContent = "選擇日期：";
      renderDateOptions();
      renderTable();
    }
  });

  // 收入支出切換按鈕事件
  btnIncome.addEventListener("click", () => {
    if (currentTypeFilter !== 'income') {
      currentTypeFilter = 'income';
      btnIncome.classList.add("active");
      btnExpense.classList.remove("active");
      renderDateOptions();
      renderTable();
    }
  });

  btnExpense.addEventListener("click", () => {
    if (currentTypeFilter !== 'expense') {
      currentTypeFilter = 'expense';
      btnExpense.classList.add("active");
      btnIncome.classList.remove("active");
      renderDateOptions();
      renderTable();
    }
  });

  datePicker.addEventListener("change", () => {
    renderTable();
  });

  async function init() {
    await loadData();
    renderDateOptions();
    renderTable();
  }

  init();
</script>
