<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>記帳系統 - 深色主題</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    /* 主背景 */
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 30px auto;
      background-color: #121212;
      color: #e0e0e0;
    }

    /* 表格 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #1e1e1e;
      box-shadow: 0 0 10px #000000aa;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
      color: #e0e0e0;
    }

    th {
      background-color: #252525;
      color: #ffffff;
      font-weight: bold;
      box-shadow: inset 0 -2px 3px #000000aa;
    }

    /* 按鈕 */
    button {
      margin: 5px;
      padding: 6px 12px;
      background-color: #252525;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 2px 6px #000000cc;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    button:hover {
      background-color: #3a3a3a;
      box-shadow: 0 4px 12px #000000ee;
    }

    /* 選取框和輸入框 */
    select, input[type="date"], input[type="number"], input[type="text"] {
      margin: 5px;
      padding: 6px;
      background-color: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 5px;
      box-shadow: inset 0 0 5px #000000cc;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #4b6cb7;
      box-shadow: 0 0 6px #4b6cb7aa;
      background-color: #2d2d2d;
      color: #e0e0e0;
    }

    /* 導航按鈕 */
    .nav-button {
      display: block;
      width: 200px;
      margin: 30px auto;
      padding: 10px;
      background-color: #252525;
      color: #ffffff;
      text-align: center;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      box-shadow: 0 4px 12px #000000cc;
      transition: background-color 0.3s;
    }
    .nav-button:hover {
      background-color: #3a3a3a;
    }

    /* 切換按鈕群組 */
    .filter-toggle, .type-filter {
      margin: 15px 0 5px;
      text-align: center;
    }
    .filter-toggle button, .type-filter button {
      margin: 0 10px;
      padding: 8px 20px;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #333333;
      color: #b0b0b0;
      box-shadow: 0 2px 6px #000000cc;
      transition: background-color 0.3s, color 0.3s;
    }
    .filter-toggle button.active, .type-filter button.active {
      background-color: #4b6cb7;
      color: #ffffff;
      box-shadow: 0 4px 12px #274a9dcc;
    }
    .filter-toggle button:hover:not(.active), .type-filter button:hover:not(.active) {
      background-color: #444444;
      color: #e0e0e0;
    }

    /* 編輯彈窗 Modal 背景和卡片 */
    #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(18,18,18,0.9);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #editModal > div {
      background: #252525;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      box-sizing: border-box;
      box-shadow: 0 8px 20px #000000cc;
      color: #e0e0e0;
    }
    #editModal h3 {
      margin-top: 0;
      color: #ffffff;
    }
    #editForm label {
      display: block;
      margin-bottom: 10px;
      color: #b0b0b0;
    }
    #editForm input, #editForm select {
      width: 100%;
      padding: 6px;
      background-color: #2d2d2d;
      border: 1px solid #333;
      border-radius: 5px;
      color: #e0e0e0;
      box-shadow: inset 0 0 5px #000000cc;
      box-sizing: border-box;
    }
    #editForm div {
      text-align: right;
    }
    #editForm button {
      padding: 6px 12px;
      margin-left: 10px;
      cursor: pointer;
      background-color: #333;
      border: 1px solid #444;
      color: #e0e0e0;
      box-shadow: 0 2px 6px #000000cc;
      transition: background-color 0.3s;
    }
    #editForm button:hover {
      background-color: #4b6cb7;
      border-color: #3a56a0;
      box-shadow: 0 4px 12px #274a9dcc;
      color: #fff;
    }
  </style>
</head>
<body>
  <h2 style="color:#ffffff;">記帳系統</h2>

  <div class="filter-toggle">
    <button id="btnMonth" class="active">按月</button>
    <button id="btnDay">按日</button>
  </div>

  <div class="type-filter">
    <button id="btnAll" class="active">全部</button>
    <button id="btnIncome">收入</button>
    <button id="btnExpense">支出</button>
  </div>

  <label for="datePicker" style="color:#b0b0b0;">選擇月份：</label>
  <select id="datePicker"></select>

  <table>
    <thead>
      <tr>
        <th>日期</th>
        <th>類型</th>
        <th>金額</th>
        <th>備註</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="recordsTableBody"></tbody>
  </table>

  <a href="index.html" class="nav-button">返回財務分析面板</a>

  <!-- 編輯彈窗 Modal -->
  <div id="editModal">
    <div>
      <h3>編輯記錄</h3>
      <form id="editForm">
        <label>
          日期 (YYYY-MM-DD)<br />
          <input type="date" id="editDate" required />
        </label>
        <label>
          類型<br />
          <select id="editType" required>
            <option value="income">收入</option>
            <option value="expense">支出</option>
          </select>
        </label>
        <label>
          金額<br />
          <input type="number" id="editAmount" min="0" step="0.01" required />
        </label>
        <label>
          備註<br />
          <input type="text" id="editNote" />
        </label>
        <div>
          <button type="button" id="editCancelBtn">取消</button>
          <button type="submit">儲存</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyDEOsfYrAGpAnYsiYyBpaYCC-EFL9dnL6k",
      authDomain: "project-1743045136631756226.firebaseapp.com",
      projectId: "project-1743045136631756226",
      storageBucket: "project-1743045136631756226.firebasestorage.app",
      messagingSenderId: "660576126542",
      appId: "1:660576126542:web:ff0f574ec65385b7fa251f",
      measurementId: "G-31VC1RK1HK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 全域變數
    let allData = [];
    let currentFilter = 'month'; // month 或 day
    let currentTypeFilter = 'all'; // all, income, expense
    let editingId = null;

    // 元素
    const btnMonth = document.getElementById("btnMonth");
    const btnDay = document.getElementById("btnDay");
    const btnAll = document.getElementById("btnAll");
    const btnIncome = document.getElementById("btnIncome");
    const btnExpense = document.getElementById("btnExpense");
    const datePicker = document.getElementById("datePicker");
    const recordsTableBody = document.getElementById("recordsTableBody");

    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    const editDate = document.getElementById("editDate");
    const editType = document.getElementById("editType");
    const editAmount = document.getElementById("editAmount");
    const editNote = document.getElementById("editNote");
    const editCancelBtn = document.getElementById("editCancelBtn");

    // 載入資料
    async function loadData() {
      try {
        const snapshot = await db.collection("records").get();
        allData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
      } catch (err) {
        alert("讀取資料失敗：" + err.message);
      }
    }

    // 渲染日期下拉選單
    function renderDateOptions() {
      const datesSet = new Set();
      allData.forEach(item => {
        if (currentFilter === 'month') {
          // 取年月
          const ym = item.date.slice(0, 7);
          datesSet.add(ym);
        } else {
          // 取完整日期
          datesSet.add(item.date);
        }
      });
      const dates = Array.from(datesSet).sort((a,b) => a.localeCompare(b));
      datePicker.innerHTML = "";
      dates.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        datePicker.appendChild(opt);
      });
    }

    // 渲染表格
    function renderTable() {
      const filterVal = datePicker.value;
      let filtered = allData;

      // 篩選類型
      if (currentTypeFilter !== 'all') {
        filtered = filtered.filter(d => d.type === currentTypeFilter);
      }

      // 篩選日期
      if (filterVal) {
        if (currentFilter === 'month') {
          filtered = filtered.filter(d => d.date.startsWith(filterVal));
        } else {
          filtered = filtered.filter(d => d.date === filterVal);
        }
      }

      // 清空表格
      recordsTableBody.innerHTML = "";

      // 顯示資料
      filtered.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.date}</td>
          <td>${item.type === 'income' ? '收入' : '支出'}</td>
          <td>${item.amount.toFixed(2)}</td>
          <td>${item.note || ''}</td>
          <td>
            <button class="edit-btn" data-id="${item.id}">編輯</button>
            <button class="delete-btn" data-id="${item.id}">刪除</button>
          </td>
        `;
        recordsTableBody.appendChild(tr);
      });

      // 刪除按鈕監聽
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const id = e.target.dataset.id;
          if (confirm("確定刪除此筆資料？")) {
            try {
              await db.collection("records").doc(id).delete();
              alert("刪除成功");
              await loadData();
              renderDateOptions();
              renderTable();
            } catch (err) {
              alert("刪除失敗：" + err.message);
            }
          }
        });
      });

      // 編輯按鈕監聽
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          const id = e.target.dataset.id;
          openEditModal(id);
        });
      });
    }

    function openEditModal(id) {
      const item = allData.find(d => d.id === id);
      if (!item) return alert("找不到該筆資料");
      editingId = id;
      editDate.value = item.date;
      editType.value = item.type;
      editAmount.value = item.amount;
      editNote.value = item.note || "";
      editModal.style.display = "flex";
    }

    function closeEditModal() {
      editingId = null;
      editModal.style.display = "none";
      editForm.reset();
    }

    // 按鈕事件
    btnMonth.addEventListener("click", () => {
      currentFilter = 'month';
      btnMonth.classList.add("active");
      btnDay.classList.remove("active");
      renderDateOptions();
      renderTable();
    });
    btnDay.addEventListener("click", () => {
      currentFilter = 'day';
      btnDay.classList.add("active");
      btnMonth.classList.remove("active");
      renderDateOptions();
      renderTable();
    });

    btnAll.addEventListener("click", () => {
      currentTypeFilter = 'all';
      btnAll.classList.add("active");
      btnIncome.classList.remove("active");
      btnExpense.classList.remove("active");
      renderTable();
    });
    btnIncome.addEventListener("click", () => {
      currentTypeFilter = 'income';
      btnIncome.classList.add("active");
      btnAll.classList.remove("active");
      btnExpense.classList.remove("active");
      renderTable();
    });
    btnExpense.addEventListener("click", () => {
      currentTypeFilter = 'expense';
      btnExpense.classList.add("active");
      btnAll.classList.remove("active");
      btnIncome.classList.remove("active");
      renderTable();
    });

    datePicker.addEventListener("change", () => {
      renderTable();
    });

    // 編輯彈窗取消按鈕
    editCancelBtn.addEventListener("click", () => {
      closeEditModal();
    });

    // 編輯表單送出
    editForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!editingId) return alert("編輯時發生錯誤，找不到資料ID");

      const updatedData = {
        date: editDate.value,
        type: editType.value,
        amount: parseFloat(editAmount.value),
        note: editNote.value,
      };

      try {
        await db.collection("records").doc(editingId).update(updatedData);
        alert("✅ 編輯成功");
        closeEditModal();
        await loadData();
        renderDateOptions();
        renderTable();
      } catch (err) {
        alert("更新失敗：" + err.message);
      }
    });

    // 初始化載入
    (async function init() {
      await loadData();
      renderDateOptions();
      renderTable();
    })();
  </script>
</body>
</html>
