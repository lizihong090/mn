<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è¨˜å¸³æœ¬ - æ”¶å…¥æ”¯å‡ºèˆ‡ç´¯ç©æ”¶å…¥æŠ˜ç·šåœ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 p-6">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow space-y-6">
        <h1 class="text-3xl font-bold text-center">è¨˜å¸³æœ¬ï¼ˆæ¯æ—¥æ”¶å…¥ & æ”¯å‡ºæŸ±ç‹€ + ç´¯ç©æ”¶å…¥æŠ˜ç·šï¼‰</h1>

        <form id="entryForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="item" placeholder="é …ç›®åç¨±" required class="border p-2 rounded" />
            <input type="number" id="amount" placeholder="é‡‘é¡" required class="border p-2 rounded" />
            <select id="type" required class="border p-2 rounded">
        <option value="income">æ”¶å…¥</option>
        <option value="expense">æ”¯å‡º</option>
      </select>
            <input type="date" id="date" required class="border p-2 rounded" />
            <button type="submit" class="col-span-1 md:col-span-2 bg-blue-600 text-white rounded p-2 hover:bg-blue-700 transition">
        æ–°å¢ç´€éŒ„
      </button>
        </form>

        <section>
            <h2 class="text-xl font-semibold mb-2">è¨˜å¸³ç´€éŒ„</h2>
            <ul id="records" class="divide-y border rounded max-h-60 overflow-auto bg-gray-50"></ul>
        </section>

        <section class="pt-4 border-t space-y-1">
            <p>ç¸½æ”¶å…¥ï¼š<span id="totalIncome" class="text-green-600 font-semibold">0</span> å…ƒ</p>
            <p>ç¸½æ”¯å‡ºï¼š<span id="totalExpense" class="text-red-600 font-semibold">0</span> å…ƒ</p>
            <p class="font-bold">é¤˜é¡ï¼š<span id="balance" class="font-semibold">0</span> å…ƒ</p>
        </section>

        <section class="pt-6 border-t">
            <label for="monthPicker" class="font-semibold">é¸æ“‡æœˆä»½ï¼š</label>
            <input type="month" id="monthPicker" class="border p-2 rounded mb-3" />
            <canvas id="barChart" height="250"></canvas>
        </section>
    </div>

    <script>
        const entryForm = document.getElementById("entryForm");
        const records = document.getElementById("records");
        const totalIncome = document.getElementById("totalIncome");
        const totalExpense = document.getElementById("totalExpense");
        const balance = document.getElementById("balance");
        const monthPicker = document.getElementById("monthPicker");

        let entries = [];

        const ctx = document.getElementById("barChart").getContext("2d");
        const barChart = new Chart(ctx, {
            data: {
                labels: [],
                datasets: [{
                    type: 'bar',
                    label: 'æ¯æ—¥æ”¶å…¥',
                    data: [],
                    backgroundColor: '#22c55e',
                }, {
                    type: 'bar',
                    label: 'æ¯æ—¥æ”¯å‡º',
                    data: [],
                    backgroundColor: '#ef4444',
                }, {
                    type: 'line',
                    label: 'ç´¯ç©æ”¶å…¥æŠ˜ç·š',
                    data: [],
                    borderColor: '#3b82f6',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // é è¨­æœˆä»½é¸æ“‡ä»Šå¤©æ‰€åœ¨æœˆä»½
        const today = new Date();
        const defaultMonth = today.toISOString().slice(0, 7);
        monthPicker.value = defaultMonth;

        window.addEventListener("load", () => {
            const saved = localStorage.getItem("entries");
            if (saved) entries = JSON.parse(saved);
            updateUI();
        });

        function saveToLocalStorage() {
            localStorage.setItem("entries", JSON.stringify(entries));
        }

        entryForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const item = document.getElementById("item").value.trim();
            const amount = parseFloat(document.getElementById("amount").value);
            const type = document.getElementById("type").value;
            const date = document.getElementById("date").value;

            if (!item || !amount || !date) {
                alert("è«‹å®Œæ•´å¡«å¯«é …ç›®ã€é‡‘é¡èˆ‡æ—¥æœŸ");
                return;
            }

            entries.push({
                item,
                amount,
                type,
                date
            });
            saveToLocalStorage();
            updateUI();
            entryForm.reset();
        });

        function deleteEntry(index) {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
                entries.splice(index, 1);
                saveToLocalStorage();
                updateUI();
            }
        }
        window.deleteEntry = deleteEntry;

        function updateUI() {
            records.innerHTML = "";
            let income = 0,
                expense = 0;
            entries.forEach((entry, index) => {
                const li = document.createElement("li");
                li.className = "flex justify-between items-center py-2 px-3";
                li.innerHTML = `
          <div>
            <p class="font-semibold">${entry.item} (${entry.type === "income" ? "æ”¶å…¥" : "æ”¯å‡º"})</p>
            <p class="text-sm text-gray-500">${entry.date}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="${entry.type === "income" ? "text-green-600" : "text-red-600"}">
              ${entry.type === "income" ? "+" : "-"}${entry.amount}
            </span>
            <button class="text-red-500 hover:text-red-700" onclick="deleteEntry(${index})" title="åˆªé™¤ç´€éŒ„">ğŸ—‘ï¸</button>
          </div>`;
                records.appendChild(li);
                if (entry.type === "income") income += entry.amount;
                else expense += entry.amount;
            });

            totalIncome.textContent = income.toFixed(2);
            totalExpense.textContent = expense.toFixed(2);
            balance.textContent = (income - expense).toFixed(2);

            updateIncomeExpenseChart(monthPicker.value);
        }

        function updateIncomeExpenseChart(monthStr) {
            if (!monthStr) return;

            const [yearStr, monthStrOnly] = monthStr.split("-");
            const year = parseInt(yearStr);
            const month = parseInt(monthStrOnly);
            const daysInMonth = new Date(year, month, 0).getDate();

            const labels = [];
            const incomeByDay = Array(daysInMonth).fill(0);
            const expenseByDay = Array(daysInMonth).fill(0);

            for (let d = 1; d <= daysInMonth; d++) {
                labels.push(`${monthStr}-${String(d).padStart(2, "0")}`);
            }

            entries.forEach(entry => {
                if (entry.date.startsWith(monthStr)) {
                    const day = parseInt(entry.date.split("-")[2]) - 1;
                    if (entry.type === "income") {
                        incomeByDay[day] += entry.amount;
                    } else if (entry.type === "expense") {
                        expenseByDay[day] += entry.amount;
                    }
                }
            });

            // è¨ˆç®—ç´¯ç©æ”¶å…¥æŠ˜ç·šè³‡æ–™
            const cumulativeIncome = [];
            let sum = 0;
            for (let i = 0; i < incomeByDay.length; i++) {
                sum += incomeByDay[i];
                cumulativeIncome[i] = sum;
            }

            barChart.data.labels = labels;
            barChart.data.datasets[0].data = incomeByDay; // æ¯æ—¥æ”¶å…¥æŸ±ç‹€
            barChart.data.datasets[1].data = expenseByDay; // æ¯æ—¥æ”¯å‡ºæŸ±ç‹€
            barChart.data.datasets[2].data = cumulativeIncome; // ç´¯ç©æ”¶å…¥æŠ˜ç·š
            barChart.update();
        }

        monthPicker.addEventListener("change", () => {
            updateIncomeExpenseChart(monthPicker.value);
        });
    </script>
</body>

</html>
