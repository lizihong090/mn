<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>記帳圖表 - 當月收入支出累積</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    select { font-size: 16px; padding: 4px; margin-bottom: 20px; }
    canvas { max-width: 900px; max-height: 400px; }
  </style>
</head>
<body>

  <h2>記帳系統 - 當月收入支出累積圖</h2>

  <label for="monthSelect">選擇月份：</label>
  <select id="monthSelect"></select>

  <canvas id="myChart"></canvas>

  <script>
    // 1. Firebase 初始化設定，請改成你的 firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyDEOsfYrAGpAnYsiYyBpaYCC-EFL9dnL6k",
      authDomain: "project-1743045136631756226.firebaseapp.com",
      projectId: "project-1743045136631756226",
      storageBucket: "project-1743045136631756226.firebasestorage.app",
      messagingSenderId: "660576126542",
      appId: "1:660576126542:web:ff0f574ec65385b7fa251f",
      measurementId: "G-31VC1RK1HK"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. 月份選擇下拉初始化 (從今年1月到12月，或可改為動態)
    const monthSelect = document.getElementById("monthSelect");
    const today = new Date();
    const currentYear = today.getFullYear();

    function pad(n){ return n<10 ? "0"+n : n; }

    for(let m=1; m<=12; m++) {
      const option = document.createElement("option");
      option.value = `${currentYear}-${pad(m)}`;
      option.textContent = `${currentYear} 年 ${m} 月`;
      monthSelect.appendChild(option);
    }
    monthSelect.value = `${currentYear}-${pad(today.getMonth()+1)}`;

    // 3. 讀取資料並畫圖

    let chart = null;

    async function fetchAndDraw(yearMonth) {
      // 讀 firestore 資料
      const snapshot = await db.collection("records")
        .where("date", ">=", yearMonth + "-01")
        .where("date", "<=", yearMonth + "-31")
        .get();

      const records = [];
      snapshot.forEach(doc => {
        records.push(doc.data());
      });

      const { dailyIncome, dailyExpense, totalIncome } = accumulateByDate(records, yearMonth);
      drawChart(dailyIncome, dailyExpense, totalIncome);
    }

    // 計算每日累積
    function accumulateByDate(records, yearMonth) {
      const [year, month] = yearMonth.split("-").map(Number);
      const daysInMonth = new Date(year, month, 0).getDate();

      let dailyIncome = new Array(daysInMonth).fill(0);
      let dailyExpense = new Array(daysInMonth).fill(0);

      records.forEach(({ date, type, amount }) => {
        if (!date.startsWith(yearMonth)) return;
        const day = Number(date.slice(-2));
        if (type === "income") dailyIncome[day - 1] += amount;
        else if (type === "expense") dailyExpense[day - 1] += amount;
      });

      for (let i = 1; i < daysInMonth; i++) {
        dailyIncome[i] += dailyIncome[i - 1];
        dailyExpense[i] += dailyExpense[i - 1];
      }

      return {
        dailyIncome,
        dailyExpense,
        totalIncome: dailyIncome[daysInMonth - 1] || 0
      };
    }

    function drawChart(dailyIncome, dailyExpense, totalIncome) {
      const days = dailyIncome.length;
      const labels = Array.from({ length: days }, (_, i) => i + 1);
      const totalIncomeLine = new Array(days).fill(totalIncome);

      const ctx = document.getElementById("myChart").getContext("2d");

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "當月收入（日累積）",
              data: dailyIncome,
              borderColor: "green",
              fill: false,
              tension: 0.2,
            },
            {
              label: "當月支出（日累積）",
              data: dailyExpense,
              borderColor: "red",
              fill: false,
              tension: 0.2,
            },
            {
              label: "當月收入（總累積）",
              data: totalIncomeLine,
              borderColor: "blue",
              borderDash: [8,5],
              fill: false,
              tension: 0.2,
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" }
          },
          scales: {
            x: { title: { display: true, text: "日期" } },
            y: { title: { display: true, text: "金額" }, beginAtZero: true }
          }
        }
      });
    }

    // 監聽月份選擇改變
    monthSelect.addEventListener("change", e => {
      fetchAndDraw(e.target.value);
    });

    // 初始畫面載入當月資料
    fetchAndDraw(monthSelect.value);

  </script>
</body>
</html>
