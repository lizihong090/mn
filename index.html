<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>記帳系統</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label, select, canvas { display: block; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>記帳系統</h1>

  <!-- 月份篩選 -->
  <label for="month-select">選擇月份：</label>
  <select id="month-select">
    <option value="">全部</option>
    <option value="01">1月</option>
    <option value="02">2月</option>
    <option value="03">3月</option>
    <option value="04">4月</option>
    <option value="05">5月</option>
    <option value="06">6月</option>
    <option value="07">7月</option>
    <option value="08">8月</option>
    <option value="09">9月</option>
    <option value="10">10月</option>
    <option value="11">11月</option>
    <option value="12">12月</option>
  </select>

  <!-- 圖表顯示 -->
  <h3>每月支出圖表</h3>
  <canvas id="chart"></canvas>

  <script>
    // 初始化 Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDEOsfYrAGpAnYsiYyBpaYCC-EFL9dnL6k",
      authDomain: "project-1743045136631756226.firebaseapp.com",
      projectId: "project-1743045136631756226",
      storageBucket: "project-1743045136631756226.appspot.com",
      messagingSenderId: "660576126542",
      appId: "1:660576126542:web:ff0f574ec65385b7fa251f",
      measurementId: "G-31VC1RK1HK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const chartCanvas = document.getElementById('chart');
    const monthSelect = document.getElementById('month-select');

    let chart;

    // 畫圖表函式
    function renderChart(data) {
      const monthlyTotal = {};

      data.forEach(entry => {
        const date = new Date(entry.date);
        const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (!monthlyTotal[month]) monthlyTotal[month] = 0;
        monthlyTotal[month] += entry.amount;
      });

      const labels = Object.keys(monthlyTotal).sort();
      const amounts = labels.map(month => monthlyTotal[month]);

      if (chart) chart.destroy();

      chart = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '每月總支出',
            data: amounts,
            backgroundColor: 'rgba(75, 192, 192, 0.6)'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // 載入 Firestore 資料
    function loadData() {
      db.collection("expenses").get().then(snapshot => {
        const data = [];
        snapshot.forEach(doc => {
          const record = doc.data();
          if (record.date && record.amount != null) {
            data.push({
              date: record.date,
              amount: Number(record.amount),
              id: doc.id
            });
          }
        });

        // 排序資料（日期升冪）
        const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));

        // 依月份篩選
        const selectedMonth = monthSelect.value;
        const filteredData = selectedMonth ? sortedData.filter(entry => {
          const entryMonth = new Date(entry.date).getMonth() + 1;
          return String(entryMonth).padStart(2, '0') === selectedMonth;
        }) : sortedData;

        renderChart(filteredData);
      });
    }

    // 月份選單改變時載入資料
    monthSelect.addEventListener('change', loadData);

    // 初始載入
    loadData();
  </script>
</body>
</html>
